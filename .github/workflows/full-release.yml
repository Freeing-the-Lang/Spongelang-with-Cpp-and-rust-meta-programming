name: "SpongeLang Full Build — Rust + NASM + C++ Meta + Release"

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: "Build & Test"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ------------------------------------------------------
      # Checkout
      # ------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------
      # Install Tools
      # ------------------------------------------------------
      - name: Install tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm clang

      - name: Install tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install nasm
          brew install llvm || true

      - name: Install tools (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install nasm -y

      # ------------------------------------------------------
      # Rust Build (compiler)
      # ------------------------------------------------------
      - name: Build SpongeLang compiler
        run: cargo build --release

      # ------------------------------------------------------
      # Generate ASM via SpongeLang
      # ------------------------------------------------------
      - name: Generate ASM
        run: |
          mkdir -p build
          ./target/release/sponge-meta-lang examples/hello.sp > build/out.asm

      # ------------------------------------------------------
      # NASM → OS별 실행 파일 생성
      # ------------------------------------------------------
      - name: NASM compile (Linux)
        if: runner.os == 'Linux'
        run: |
          nasm -f elf64 build/out.asm -o build/out.o
          ld build/out.o -o build/a.out

      - name: NASM compile (macOS)
        if: runner.os == 'macOS'
        run: |
          nasm -f macho64 build/out.asm -o build/out.o
          ld -macosx_version_min 11.0 -o build/a.out build/out.o -lSystem

      - name: NASM compile (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          nasm -f win64 build/out.asm -o build/out.obj
          link /entry:_start /SUBSYSTEM:CONSOLE build/out.obj /OUT:build\\a.exe

      # ------------------------------------------------------
      # C++ Meta Test
      # ------------------------------------------------------
      - name: C++ meta test (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          mkdir -p cpp_test
          cat << 'EOF' > cpp_test/test.cpp
#include "../include/sponge_meta.hpp"
#include "../include/meta_expand.hpp"
int main() {
    meta_expand<int>();
    return 0;
}
EOF
          clang++ -std=c++20 cpp_test/test.cpp -o cpp_test/test

      - name: C++ meta test (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          mkdir cpp_test
          Set-Content -Path cpp_test/test.cpp -Value '#include "../include/sponge_meta.hpp"
#include "../include/meta_expand.hpp"
int main(){ meta_expand<int>(); return 0; }'
          cl /std:c++20 cpp_test/test.cpp /EHsc

      # ------------------------------------------------------
      # Artifact Packaging
      # ------------------------------------------------------
      - name: Package Artifact
        run: |
          mkdir -p artifact
          cp -r target/release artifact/
          cp -r build artifact/
          cp -r include artifact/
          zip -r "${{ runner.os }}_build.zip" artifact/*

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-build
          path: ./*.zip


  # ------------------------------------------------------
  # Release Job (SHA256 Ledger 포함)
  # ------------------------------------------------------
  release:
    name: "Release & ProofLedger"
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: releases

      - name: Generate ProofLedger
        run: |
          echo "SpongeLang Auto Release" > ProofLedger.txt
          echo "Generated: $(date -u)" >> ProofLedger.txt
          echo "" >> ProofLedger.txt
          for f in $(find releases -type f); do
            sha256sum "$f" >> ProofLedger.txt
          done

      - name: Bundle everything
        run: |
          zip -r full_bundle.zip releases/ ProofLedger.txt

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "SpongeLang Release — ${{ github.ref_name }}"
          body: |
            SpongeLang Multi-OS Build Pipeline
            - Rust Compiler (ASM generator)
            - NASM Backend (Linux/macOS/Windows)
            - C++ Template Meta Test
            - Artifact Bundles per OS
            - SHA256 ProofLedger Included
          files: |
            full_bundle.zip
            releases/**/*.zip
            ProofLedger.txt
