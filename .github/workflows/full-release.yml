name: "SpongeLang External Compiler Pipeline â€” Auto Detect Assets + PRO Release"

on:
  workflow_dispatch:

  repository_dispatch:
    types: [spongelang-new-tag]

  push:
    tags:
      - "v*"

permissions:
  contents: write


jobs:
  resolve-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}

    steps:
      - name: Resolve Tag
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "tag=${{ github.event.client_payload.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi



  build:
    needs: resolve-tag
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4


      # ------------------------------------------------------------
      # ðŸ”¥ Auto-detect correct asset name for this OS
      # ------------------------------------------------------------
      - name: Detect Correct Compiler Asset
        id: asset
        shell: bash
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"

          echo "Fetching asset list for TAG: $TAG"
          curl -s https://api.github.com/repos/Freeing-the-Lang/SpongeLang/releases/tags/$TAG \
            -o assets.json

          echo "=== Available assets ==="
          cat assets.json | jq -r '.assets[].name'

          if [[ "${{ runner.os }}" == "Linux" ]]; then
            KEYWORD="linux"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            KEYWORD="macos"
          else
            KEYWORD="windows"
          fi

          # find first match
          ASSET=$(cat assets.json | jq -r '.assets[].name' | grep -i "$KEYWORD" | head -n 1)

          if [[ -z "$ASSET" ]]; then
            echo "âŒ No matching asset for OS keyword: $KEYWORD"
            exit 1
          fi

          echo "asset=$ASSET" >> $GITHUB_OUTPUT
          echo "Detected asset: $ASSET"


      # ------------------------------------------------------------
      # ðŸ”¥ Download + unzip compiler safely
      # ------------------------------------------------------------
      - name: Download Compiler
        shell: bash
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          ASSET="${{ steps.asset.outputs.asset }}"
          URL="https://github.com/Freeing-the-Lang/SpongeLang/releases/download/$TAG/$ASSET"

          mkdir -p tools
          echo "Downloading: $URL"

          curl -L -o tools/$ASSET "$URL"

          # Validate size
          SIZE=$(wc -c < tools/$ASSET)
          echo "Downloaded size: $SIZE bytes"

          if [[ "$SIZE" -lt 200 ]]; then
            echo "âŒ ERROR: File too small, probably HTML error page."
            cat tools/$ASSET
            exit 1
          fi

          unzip tools/$ASSET -d tools || (echo "âŒ Not a valid zip!"; exit 1)

          echo "Tools:"
          ls -R tools


      # ------------------------------------------------------------
      # Install Tools
      # ------------------------------------------------------------
      - name: Install Tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm clang

      - name: Install Tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install nasm
          brew install llvm

      - name: Install Tools (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: choco install nasm -y


      # ------------------------------------------------------------
      # Generate ASM
      # ------------------------------------------------------------
      - name: Run SpongeLang â†’ ASM
        shell: bash
        run: |
          mkdir -p build
          BIN=$(find tools -maxdepth 1 -type f -perm -u+x ! -name "*.dll" ! -name "*.dylib" ! -name "*.zip" | head -n 1)

          if [[ -z "$BIN" ]]; then
            echo "âŒ Could not find executable in tools/"
            ls -al tools
            exit 1
          fi

          echo "Using binary: $BIN"

          $BIN examples/hello.sp > build/out.asm


      # ------------------------------------------------------------
      # NASM + LINK
      # ------------------------------------------------------------
      - name: Build Binary (Linux)
        if: runner.os == 'Linux'
        run: |
          nasm -f elf64 build/out.asm -o build/out.o
          ld build/out.o -o build/a.out

      - name: Build Binary (macOS)
        if: runner.os == 'macOS'
        run: |
          nasm -f macho64 build/out.asm -o build/out.o
          clang -o build/a.out build/out.o -lSystem

      - name: Build Binary (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          nasm -f win64 build/out.asm -o build/out.obj
          cl build/out.obj /link /ENTRY:_start /SUBSYSTEM:CONSOLE /OUT:build\a.exe

      # ------------------------------------------------------------
      # Package
      # ------------------------------------------------------------
      - name: Package Artifact
        run: |
          OSNAME="${{ matrix.os }}"
          OSNAME="${OSNAME/-latest/}"
          mkdir artifact
          cp -r build artifact/
          cp -r include artifact/ || true
          zip -r "${OSNAME}_build.zip" artifact/*

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}
          path: ./*_build.zip



  release:
    needs: [resolve-tag, build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: releases

      - name: Generate ProofLedger
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"

          echo "SpongeLang External Compiler Build" > ProofLedger.txt
          echo "Version: $TAG" >> ProofLedger.txt
          echo "Generated: $(date -u)" >> ProofLedger.txt
          echo "" >> ProofLedger.txt

          find releases -name "*.zip" -type f -print0 |
          while IFS= read -r -d '' f; do
            sha256sum "$f" >> ProofLedger.txt
          done

      - name: Bundle
        run: zip -r full_bundle.zip releases/ ProofLedger.txt

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.resolve-tag.outputs.tag }}
          name: "SpongeLang External Build â€” ${{ needs.resolve-tag.outputs.tag }}"
          body: |
            ðŸ”¥ Auto-detected compiler assets
            ðŸ”¥ Multi-OS NASM backend
            ðŸ”¥ ProofLedger (all SHA256)
            ðŸ”¥ Fully reproducible external build pipeline
          files: |
            full_bundle.zip
            ProofLedger.txt
            releases/**/*.zip
