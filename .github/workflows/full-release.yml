name: "SpongeLang External Compiler Pipeline — Auto Detect + Latest Fallback"

on:
  workflow_dispatch:

  repository_dispatch:
    types: [spongelang-new-tag]

  push:
    tags:
      - "v*"

permissions:
  contents: write


# =====================================================================
# 1) TAG RESOLUTION (supports dispatch, tag push, and fallback)
# =====================================================================
jobs:
  resolve-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.final.outputs.tag }}

    steps:
      - name: Detect Incoming Tag
        id: detect
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "raw=${{ github.event.client_payload.tag }}" >> $GITHUB_OUTPUT
          else
            echo "raw=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Fix TAG (fallback when main branch)
        id: final
        run: |
          RAW="${{ steps.detect.outputs.raw }}"

          if [[ "$RAW" == "main" ]]; then
            echo "TAG='main' → Using latest SpongeLang release"
            TAG=$(curl -s https://api.github.com/repos/Freeing-the-Lang/SpongeLang/releases/latest \
                  | jq -r .tag_name)

            if [[ "$TAG" == "null" || -z "$TAG" ]]; then
              echo "❌ No latest release found!"
              exit 1
            fi

            echo "tag=$TAG" >> $GITHUB_OUTPUT
          else
            echo "tag=$RAW" >> $GITHUB_OUTPUT
          fi

      - name: Show final tag
        run: echo "Final TAG = ${{ steps.final.outputs.tag }}"


# =====================================================================
# 2) MULTI-OS BUILD
# =====================================================================
  build:
    needs: resolve-tag
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Auto-detect correct asset by OS
      # ------------------------------------------------------------
      - name: Detect Release Asset
        id: asset
        shell: bash
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          echo "Fetching assets for TAG: $TAG"

          curl -s https://api.github.com/repos/Freeing-the-Lang/SpongeLang/releases/tags/$TAG \
            -o assets.json

          echo "=== Available assets ==="
          cat assets.json | jq -r '.assets[].name'

          if [[ "${{ runner.os }}" == "Linux" ]]; then
            KEY="linux"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            KEY="macos"
          else
            KEY="windows"
          fi

          ASSET=$(cat assets.json | jq -r '.assets[].name' | grep -i "$KEY" | head -n 1)

          if [[ -z "$ASSET" ]]; then
            echo "❌ Cannot find asset for OS keyword: $KEY"
            exit 1
          fi

          echo "asset=$ASSET" >> $GITHUB_OUTPUT
          echo "Detected asset: $ASSET"

      # ------------------------------------------------------------
      # Download + Unzip compiler safely
      # ------------------------------------------------------------
      - name: Download Compiler
        shell: bash
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          ASSET="${{ steps.asset.outputs.asset }}"
          URL="https://github.com/Freeing-the-Lang/SpongeLang/releases/download/$TAG/$ASSET"

          echo "Downloading $ASSET"
          mkdir -p tools
          curl -L -o tools/$ASSET "$URL"

          SIZE=$(wc -c < tools/$ASSET)
          echo "Size: $SIZE bytes"

          if [[ "$SIZE" -lt 200 ]]; then
            echo "❌ Downloaded file too small, likely HTML error:"
            cat tools/$ASSET
            exit 1
          fi

          unzip tools/$ASSET -d tools
          echo "Tools directory:"
          ls -R tools


      # ------------------------------------------------------------
      # Install tools
      # ------------------------------------------------------------
      - name: Install Tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm clang

      - name: Install Tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install nasm
          brew install llvm

      - name: Install Tools (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: choco install nasm -y


      # ------------------------------------------------------------
      # Generate ASM via external SpongeLang
      # ------------------------------------------------------------
      - name: Run SpongeLang → ASM
        shell: bash
        run: |
          mkdir -p build

          BIN=$(find tools -maxdepth 1 -type f -perm -u+x ! -name "*.zip" ! -name "*.dll" ! -name "*.dylib" | head -n 1)

          if [[ -z "$BIN" ]]; then
            echo "❌ No executable found in tools/"
            ls -al tools
            exit 1
          fi

          echo "Using binary: $BIN"
          $BIN examples/hello.sp > build/out.asm


      # ------------------------------------------------------------
      # NASM + link
      # ------------------------------------------------------------
      - name: Build Binary (Linux)
        if: runner.os == 'Linux'
        run: |
          nasm -f elf64 build/out.asm -o build/out.o
          ld build/out.o -o build/a.out

      - name: Build Binary (macOS)
        if: runner.os == 'macOS'
        run: |
          nasm -f macho64 build/out.asm -o build/out.o
          clang -o build/a.out build/out.o -lSystem

      - name: Build Binary (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          nasm -f win64 build/out.asm -o build/out.obj
          cl build/out.obj /link /ENTRY:_start /SUBSYSTEM:CONSOLE /OUT:build\a.exe


      # ------------------------------------------------------------
      # Package
      # ------------------------------------------------------------
      - name: Package Artifact
        run: |
          OS="${{ matrix.os }}"
          OS="${OS/-latest/}"
          mkdir artifact
          cp -r build artifact/
          cp -r include artifact/ || true
          zip -r "${OS}_build.zip" artifact/*

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}
          path: ./*_build.zip


# =====================================================================
# 3) Release + ProofLedger
# =====================================================================
  release:
    needs: [resolve-tag, build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: releases

      - name: Generate ProofLedger
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          echo "SpongeLang External Compiler Build" > ProofLedger.txt
          echo "Version: $TAG" >> ProofLedger.txt
          echo "Generated: $(date -u)" >> ProofLedger.txt
          echo "" >> ProofLedger.txt
          find releases -name "*.zip" -type f -print0 |
          while IFS= read -r -d '' f; do
            sha256sum "$f" >> ProofLedger.txt
          done

      - name: Bundle Everything
        run: zip -r full_bundle.zip releases/ ProofLedger.txt

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.resolve-tag.outputs.tag }}
          name: "SpongeLang External Build — ${{ needs.resolve-tag.outputs.tag }}"
          files: |
            full_bundle.zip
            ProofLedger.txt
            releases/**/*.zip
