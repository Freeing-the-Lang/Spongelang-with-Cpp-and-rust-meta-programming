name: "SpongeLang External Compiler Pipeline — Latest Release"

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: "Multi-OS Build"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ------------------------------------------------------
      # 1) Checkout
      # ------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4


      # ------------------------------------------------------
      # 2) Download + Extract SpongeLang Compiler (ZIP Assets)
      # ------------------------------------------------------
      - name: Download Latest SpongeLang Compiler
        shell: bash
        run: |
          mkdir -p tools

          # Determine correct asset name
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            ZFILE="linux.zip"
            BINARY="linux"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            ZFILE="macos.zip"
            BINARY="macos"
          else
            ZFILE="windows.zip"
            BINARY="windows.exe"
          fi

          URL="https://github.com/Freeing-the-Lang/SpongeLang/releases/latest/download/$ZFILE"

          echo "Downloading: $URL"
          curl -L -o tools/$ZFILE "$URL"

          echo "Unzipping..."
          unzip -d tools tools/$ZFILE

          # Validate binary existence
          if [[ ! -f "tools/$BINARY" ]]; then
            echo "ERROR: Expected binary 'tools/$BINARY' not found!"
            ls -R tools
            exit 1
          fi

          chmod +x tools/$BINARY || true


      # ------------------------------------------------------
      # 3) Install Build Tools
      # ------------------------------------------------------
      - name: Install Tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm clang

      - name: Install Tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install nasm
          brew install llvm

      - name: Install Tools (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install nasm -y


      # ------------------------------------------------------
      # 4) Run SpongeLang → ASM
      # ------------------------------------------------------
      - name: Generate ASM
        run: |
          mkdir -p build
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ./tools/windows.exe examples/hello.sp > build/out.asm
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            ./tools/macos examples/hello.sp > build/out.asm
          else
            ./tools/linux examples/hello.sp > build/out.asm
          fi


      # ------------------------------------------------------
      # 5) NASM + Link (OS-Specific)
      # ------------------------------------------------------
      - name: NASM → Binary (Linux)
        if: runner.os == 'Linux'
        run: |
          nasm -f elf64 build/out.asm -o build/out.o
          ld build/out.o -o build/a.out

      - name: NASM → Binary (macOS)
        if: runner.os == 'macOS'
        run: |
          nasm -f macho64 build/out.asm -o build/out.o
          clang -o build/a.out build/out.o -lSystem

      - name: NASM → Binary (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          nasm -f win64 build/out.asm -o build/out.obj
          cl build/out.obj /link /ENTRY:_start /SUBSYSTEM:CONSOLE /OUT:build\\a.exe


      # ------------------------------------------------------
      # 6) Artifact Packaging
      # ------------------------------------------------------
      - name: Package Artifact
        run: |
          OSNAME="${{ matrix.os }}"
          OSNAME="${OSNAME/-latest/}"
          mkdir artifact
          cp -r build artifact/
          cp -r include artifact/
          zip -r "${OSNAME}_build.zip" artifact/*

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}
          path: ./*_build.zip



  # ===================================================================
  # 7) Release + ProofLedger
  # ===================================================================
  release:
    name: "Release + ProofLedger"
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: releases

      - name: Generate ProofLedger
        run: |
          echo "SpongeLang External Compiler Build" > ProofLedger.txt
          echo "Generated: $(date -u)" >> ProofLedger.txt
          echo "" >> ProofLedger.txt

          find releases -name "*.zip" -type f -print0 | while IFS= read -r -d '' f; do
            sha256sum "$f" >> ProofLedger.txt
          done

      - name: Bundle Everything
        run: |
          zip -r full_bundle.zip releases/ ProofLedger.txt

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "SpongeLang External Build — ${{ github.ref_name }}"
          body: |
            External SpongeLang Compiler Build
            - Multi-OS NASM backend
            - External SpongeLang compiler auto-download (ZIP)
            - ProofLedger + SHA256 Verification
            - Fully reproducible build pipeline
          files: |
            full_bundle.zip
            ProofLedger.txt
            releases/**/*.zip
