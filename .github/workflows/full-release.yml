name: "SpongeLang External Compiler Pipeline â€” AUTO Chain + PRO Release"

on:
  workflow_dispatch:

  # ===============================================================
  # A) AUTO-CHAIN: Trigger when SpongeLang main repo creates a tag
  # ===============================================================
  repository_dispatch:
    types: [spongelang-new-tag]

  # Optional: if this repo ALSO wants to trigger by its own tag
  push:
    tags:
      - "v*"

permissions:
  contents: write


# =====================================================================
# JOB 1: Prepare Tag (Handles Both Local Tag + Repository Dispatch)
# =====================================================================
jobs:
  resolve-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.settag.outputs.tag }}

    steps:
      - name: Determine tag source
        id: detect
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "source=dispatch" >> $GITHUB_OUTPUT
            echo "tag=${{ github.event.client_payload.tag }}" >> $GITHUB_OUTPUT
          else
            echo "source=self" >> $GITHUB_OUTPUT
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Set Final Tag
        id: settag
        run: |
          echo "tag=${{ steps.detect.outputs.tag }}" >> $GITHUB_OUTPUT

      - name: Show tag
        run: echo "ðŸ”— Using tag: ${{ steps.settag.outputs.tag }}"


# =====================================================================
# JOB 2: Multi-OS Build
# =====================================================================
  build:
    needs: resolve-tag
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Download External Compiler
      # ------------------------------------------------------------
      - name: Download SpongeLang Compiler (tag-based)
        shell: bash
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"
          mkdir -p tools

          if [[ "${{ runner.os }}" == "Linux" ]]; then
            ZFILE="linux.zip"
            BIN="linux"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            ZFILE="macos.zip"
            BIN="macos"
          else
            ZFILE="windows.zip"
            BIN="windows.exe"
          fi

          URL="https://github.com/Freeing-the-Lang/SpongeLang/releases/download/$TAG/$ZFILE"
          echo "Downloading: $URL"

          curl -L -o tools/$ZFILE "$URL"

          if [[ ! -s tools/$ZFILE ]]; then
            echo "âŒ ERROR: Downloaded empty or missing!"
            ls -l tools
            exit 1
          fi

          unzip -d tools tools/$ZFILE
          chmod +x tools/$BIN || true

      # ------------------------------------------------------------
      # Install Build Tools
      # ------------------------------------------------------------
      - name: Install Tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm clang

      - name: Install Tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install nasm
          brew install llvm

      - name: Install Tools (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install nasm -y

      # ------------------------------------------------------------
      # SpongeLang â†’ ASM
      # ------------------------------------------------------------
      - name: Generate ASM
        run: |
          mkdir -p build
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ./tools/windows.exe examples/hello.sp > build/out.asm
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            ./tools/macos examples/hello.sp > build/out.asm
          else
            ./tools/linux examples/hello.sp > build/out.asm
          fi

      # ------------------------------------------------------------
      # NASM â†’ LINK (with fallback)
      # ------------------------------------------------------------
      - name: Build Binary (Linux)
        if: runner.os == 'Linux'
        run: |
          nasm -f elf64 build/out.asm -o build/out.o
          ld build/out.o -o build/a.out

      - name: Build Binary (macOS)
        if: runner.os == 'macOS'
        run: |
          nasm -f macho64 build/out.asm -o build/out.o
          clang -o build/a.out build/out.o -lSystem

      - name: Build Binary (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          nasm -f win64 build/out.asm -o build/out.obj
          cl build/out.obj /link /ENTRY:_start /SUBSYSTEM:CONSOLE /OUT:build\a.exe `
            || cl build/out.obj /link /ENTRY:_mainCRTStartup /SUBSYSTEM:CONSOLE /OUT:build\a.exe

      # ------------------------------------------------------------
      # Package Artifacts
      # ------------------------------------------------------------
      - name: Package Artifact
        run: |
          OS="${{ matrix.os }}"
          OS="${OS/-latest/}"
          mkdir artifact
          cp -r build artifact/
          cp -r include artifact/ || true
          zip -r "${OS}_build.zip" artifact/*

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}
          path: ./*_build.zip


# =====================================================================
# JOB 3: Release + Proof Ledger
# =====================================================================
  release:
    needs: [resolve-tag, build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: releases

      - name: Generate ProofLedger
        run: |
          TAG="${{ needs.resolve-tag.outputs.tag }}"

          echo "SpongeLang External Compiler Build" > ProofLedger.txt
          echo "Version: $TAG" >> ProofLedger.txt
          echo "Repository: $GITHUB_REPOSITORY" >> ProofLedger.txt
          echo "Commit: $GITHUB_SHA" >> ProofLedger.txt
          echo "Generated: $(date -u)" >> ProofLedger.txt
          echo "" >> ProofLedger.txt

          find releases -name "*.zip" -type f -print0 |
          while IFS= read -r -d '' f; do
            sha256sum "$f" >> ProofLedger.txt
          done

      - name: Bundle
        run: |
          zip -r full_bundle.zip releases/ ProofLedger.txt

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.resolve-tag.outputs.tag }}
          name: "SpongeLang External Build â€” ${{ needs.resolve-tag.outputs.tag }}"
          body: |
            External SpongeLang Compiler Build (AUTO CHAIN)
            - Triggered by SpongeLang main repo NEW TAG
            - Multi-OS NASM backend reproduction
            - ProofLedger + Full SHA256 Verification
            - Reproducible external compile pipeline
          files: |
            full_bundle.zip
            ProofLedger.txt
            releases/**/*.zip
