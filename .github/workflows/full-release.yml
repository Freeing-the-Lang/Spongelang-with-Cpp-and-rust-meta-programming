name: "SpongeLang External Compiler Pipeline — Latest Release"

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: "Multi-OS Build"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ------------------------------------------------------
      # 1) Checkout Repository
      # ------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------
      # 2) Download SpongeLang Compiler (Latest external release)
      # ------------------------------------------------------
      - name: Download Latest SpongeLang Compiler
        shell: bash
        run: |
          mkdir -p tools

          echo "Detected runner OS: ${{ runner.os }}"

          if [[ "${{ runner.os }}" == "Linux" ]]; then
            FILE="sponge-meta-lang-linux"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            FILE="sponge-meta-lang-macos"
          else
            FILE="sponge-meta-lang-windows.exe"
          fi

          URL="https://github.com/Freeing-the-Lang/SpongeLang/releases/latest/download/$FILE"

          echo "Downloading: $URL"

          curl -L -o tools/sponge-meta-lang "$URL"
          chmod +x tools/sponge-meta-lang || true

      # ------------------------------------------------------
      # 3) Install Build Tools
      # ------------------------------------------------------
      - name: Install tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm clang

      - name: Install tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install nasm
          brew install llvm || true

      - name: Install tools (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install nasm -y

      # ------------------------------------------------------
      # 4) Run SpongeLang to generate ASM
      # ------------------------------------------------------
      - name: Generate ASM
        run: |
          mkdir -p build
          ./tools/sponge-meta-lang examples/hello.sp > build/out.asm

      # ------------------------------------------------------
      # 5) NASM → 실행 파일 생성
      # ------------------------------------------------------
      - name: NASM (Linux)
        if: runner.os == 'Linux'
        run: |
          nasm -f elf64 build/out.asm -o build/out.o
          ld build/out.o -o build/a.out

      - name: NASM (macOS)
        if: runner.os == 'macOS'
        run: |
          nasm -f macho64 build/out.asm -o build/out.o
          ld -macosx_version_min 11.0 -o build/a.out build/out.o -lSystem

      - name: NASM (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          nasm -f win64 build/out.asm -o build/out.obj
          link /entry:_start /SUBSYSTEM:CONSOLE build/out.obj /OUT:build\\a.exe

      # ------------------------------------------------------
      # 6) C++ Template Meta Layer Test
      # ------------------------------------------------------
      - name: C++ meta test (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          mkdir -p cpp_test
          cat << 'EOF' > cpp_test/test.cpp
#include "../include/sponge_meta.hpp"
#include "../include/meta_expand.hpp"
int main() {
    meta_expand<int>();
    return 0;
}
EOF
          clang++ -std=c++20 cpp_test/test.cpp -o cpp_test/test

      - name: C++ meta test (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          mkdir cpp_test
          Set-Content cpp_test/test.cpp '#include "../include/sponge_meta.hpp"
#include "../include/meta_expand.hpp"
int main(){ meta_expand<int>(); return 0; }'
          cl /std:c++20 cpp_test/test.cpp /EHsc

      # ------------------------------------------------------
      # 7) Artifact Packaging
      # ------------------------------------------------------
      - name: Package Artifact
        run: |
          mkdir -p artifact
          cp -r build artifact/
          cp -r include artifact/
          zip -r "${{ runner.os }}_build.zip" artifact/*

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-build
          path: ./*.zip

  # ======================================================
  # 8) Release + ProofLedger
  # ======================================================
  release:
    name: "Release + ProofLedger"
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: releases

      - name: Generate Ledger
        run: |
          echo "SpongeLang External Compiler Build" > ProofLedger.txt
          echo "Generated at: $(date -u)" >> ProofLedger.txt
          echo "" >> ProofLedger.txt

          for f in $(find releases -type f); do
            sha256sum "$f" >> ProofLedger.txt
          done

      - name: Bundle All
        run: |
          zip -r full_bundle.zip releases/ ProofLedger.txt

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "SpongeLang External Build — ${{ github.ref_name }}"
          body: |
            External SpongeLang Compiler Build
            - Downloaded Latest Release Binary
            - Multi-OS NASM Backend Build
            - C++ Meta Template Layer Test
            - SHA256 ProofLedger Included
          files: |
            full_bundle.zip
            releases/**/*.zip
            ProofLedger.txt
